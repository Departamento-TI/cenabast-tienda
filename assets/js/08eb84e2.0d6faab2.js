"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6257],{4616:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var i=t(5893),s=t(1151);const o={title:"Login Process",published:!0,date:new Date("2024-02-15T14:02:49.917Z"),editor:"markdown",dateCreated:new Date("2024-02-15T21:45:58.170Z")},r="Overview",a={id:"Store Project/development-functionalities/login-process",title:"Login Process",description:"This doc explains how the implementation the login process flow and authorization onto the site",source:"@site/docs/2_Store Project/development-functionalities/login-process.md",sourceDirName:"2_Store Project/development-functionalities",slug:"/Store Project/development-functionalities/login-process",permalink:"/cenabast-tienda/docs/Store Project/development-functionalities/login-process",draft:!1,unlisted:!1,editUrl:"https://github.com/Departamento-TI/cenabast-tienda/edit/main/docs/docs/2_Store Project/development-functionalities/login-process.md",tags:[],version:"current",frontMatter:{title:"Login Process",published:!0,date:"2024-02-15T14:02:49.917Z",editor:"markdown",dateCreated:"2024-02-15T21:45:58.170Z"},sidebar:"tutorialSidebar",previous:{title:"Clave Unica",permalink:"/cenabast-tienda/docs/Store Project/development-functionalities/clave-unica"},next:{title:"Mage AI",permalink:"/cenabast-tienda/docs/Store Project/development-functionalities/mage-ai"}},l={},c=[{value:"Implementation",id:"implementation",level:2},{value:"Important environment variables",id:"important-environment-variables",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",ul:"ul",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:"This doc explains how the implementation the login process flow and authorization onto the site"})}),"\n",(0,i.jsx)(n.p,{children:"See also:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/cenabast-tienda/docs/Store%20Project/development-functionalities/clave-unica",children:"Clave Unica"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/cenabast-tienda/docs/infrastructure/clave_unica",children:"Clave Unica IdP"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/cenabast-tienda/docs/infrastructure/applications/keycloak",children:"Keycloak"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"The Cenabast site only should be accessed for authorized users."}),"\n",(0,i.jsx)(n.p,{children:"Here it is detailed how the login flow works and how the authorization check is done."}),"\n",(0,i.jsx)(n.h2,{id:"implementation",children:"Implementation"}),"\n",(0,i.jsx)(n.p,{children:"The access to the commerce site is restricted to only be accessed for authorized users."}),"\n",(0,i.jsx)(n.p,{children:"If the user is not authenticated, it will be redirected to the login page."}),"\n",(0,i.jsx)(n.p,{children:"When the user tries to log-in, it will be prompted with a login via ClaveUnica. We use Keycloak to manage an OpenID flow and obtain authentication from the ClaveUnica IdP site."}),"\n",(0,i.jsxs)(n.p,{children:["Upon a successful autentication from Keycloak/ClaveUnica, the user infromation will be redirected back to our site, onto the ",(0,i.jsx)(n.code,{children:"OmniauthCallbacksController#clave_unica"})," endpoint/action."]}),"\n",(0,i.jsxs)(n.p,{children:["Then, the requested RUN (RUT of user that is about to log in) is queried against the Cenabast APIs, using the ",(0,i.jsx)(n.code,{children:"Cenabast::Spree::User::InformationUpdater"})," class. This class is in charge of querying and updating information from:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Buyer user attributes"}),"\n",(0,i.jsx)(n.li,{children:"Provider user attributes"}),"\n",(0,i.jsx)(n.li,{children:"List of Requesters and Receivers for user (Solicitantes/Destinatarios)"}),"\n",(0,i.jsx)(n.li,{children:"List of Businesses for user (Empresas)"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Information is queried from Cenabast APIs using an API Client from Ruby, and then dumped into Spree related models."}),"\n",(0,i.jsx)(n.p,{children:"If models didnt exist before, they will be created. Existing models will be updated to reflect the newest information."}),"\n",(0,i.jsx)(n.p,{children:"If a Receiver o Business that belonged to a user is not currently returned in the new response, the association between the user and the receiver/business will be removed. The Receiver/Business will continue to exist by itself."}),"\n",(0,i.jsxs)(n.p,{children:["Then, the requested user RUN is validated if it has meets the criteria to access the site.\nThe service in charge of doing this verification is the ",(0,i.jsx)(n.code,{children:"Cenabast::Spree::User::LoginValidator"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"The flow works as following (2024/02/27):"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The RUN is searched into the user records"}),"\n",(0,i.jsxs)(n.li,{children:["Validations are evaluated","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"User must exist"}),"\n",(0,i.jsx)(n.li,{children:"User must have valid roles (user must have role buyer)"}),"\n",(0,i.jsx)(n.li,{children:"Being a buyer user (having a buyer role), the user must have at least one Receiver linked to operate"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u2705"," If the validations are met, the LoginValidator will return a success state, and the user will be logged onto the site."]}),"\n",(0,i.jsxs)(n.p,{children:["\u274c"," If the validations are not met, the LoginValidator returns a false value, an error notification message is set and the user is redirected back to the login page."]}),"\n",(0,i.jsx)(n.h3,{id:"important-environment-variables",children:"Important environment variables"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"CENABAST_API_BASE_URL"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Root URL to use"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"CENABAST_API_BASE_PATH"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Base path that points to the root of the API to use"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"CENABAST_API_USER"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"API User to obtain a token from"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"CENABAST_API_PASSWORD"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Password of the API user"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"CENABAST_API_TOKEN_EXPIRE_TIME"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"How long the token will be cached onto cache store. Value in minutes, defaults to 30."}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>a,a:()=>r});var i=t(7294);const s={},o=i.createContext(s);function r(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);