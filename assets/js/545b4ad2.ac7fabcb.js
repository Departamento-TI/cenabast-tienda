"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1818],{6365:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>l});var t=i(5893),r=i(1151);const s={title:"Product Synchronization",published:!0,date:new Date("2024-03-18T14:02:49.917Z"),editor:"markdown",dateCreated:new Date("2024-03-18T21:45:58.170Z")},o="Overview",a={id:"Store Project/development-functionalities/product-sync",title:"Product Synchronization",description:"This doc explains how scheduled product sync (bringing information from Cenabast) to Spree works",source:"@site/docs/2_Store Project/development-functionalities/product-sync.md",sourceDirName:"2_Store Project/development-functionalities",slug:"/Store Project/development-functionalities/product-sync",permalink:"/cenabast-tienda/docs/Store Project/development-functionalities/product-sync",draft:!1,unlisted:!1,editUrl:"https://github.com/Departamento-TI/cenabast-tienda/edit/main/docs/docs/2_Store Project/development-functionalities/product-sync.md",tags:[],version:"current",frontMatter:{title:"Product Synchronization",published:!0,date:"2024-03-18T14:02:49.917Z",editor:"markdown",dateCreated:"2024-03-18T21:45:58.170Z"},sidebar:"tutorialSidebar",previous:{title:"Mage AI",permalink:"/cenabast-tienda/docs/Store Project/development-functionalities/mage-ai"},next:{title:"Recomendations",permalink:"/cenabast-tienda/docs/Store Project/development-functionalities/recomendations"}},c={},l=[{value:"Implementation",id:"implementation",level:2},{value:"1 - Data importer",id:"1---data-importer",level:3},{value:"2 - Transformer",id:"2---transformer",level:3},{value:"3 - Data exporter",id:"3---data-exporter",level:3},{value:"Pipeline variables",id:"pipeline-variables",level:3},{value:"Product attributes that are not managed by the Pipeline",id:"product-attributes-that-are-not-managed-by-the-pipeline",level:3},{value:"Triggers",id:"triggers",level:3},{value:"Important environment variables",id:"important-environment-variables",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsx)(n.p,{children:"This doc explains how scheduled product sync (bringing information from Cenabast) to Spree works"})}),"\n",(0,t.jsx)(n.p,{children:"See also:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"mage.ai",children:"MageAI Documentation"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/cenabast-tienda/docs/Store%20Project/development-functionalities/mage-ai",children:"MageAI"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/cenabast-tienda/docs/api-rest-services/Cenabast/tienda",children:"API tienda V2"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"implementation",children:"Implementation"}),"\n",(0,t.jsx)(n.p,{children:"MageAI is used for the periodic data extraction and load into Spree, using APIs:"}),"\n",(0,t.jsx)(n.p,{children:"A Data Pipeline was created for the product sync. The pipeline its scheduled to run every day."}),"\n",(0,t.jsx)(n.p,{children:"A python client was created to interact with the Spree API and split into resources. Each REST resource has its own client and associated functions."}),"\n",(0,t.jsx)(n.p,{children:"The product sync data pipeline workflow can be split onto three components:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"pipeline",src:i(5783).Z+"",width:"378",height:"479"})}),"\n",(0,t.jsx)(n.h3,{id:"1---data-importer",children:"1 - Data importer"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"In charge of contacting Cenabast APIs."})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"First, it will request a token (/interoperabilidad/tienda/api/v1/auth)"}),"\n",(0,t.jsxs)(n.li,{children:["Then make an scoped query to the catalog materials endpoint, obtaining information of ZGEN products existing in cenabast (/interoperabilidad/tienda/api/v1/auth)","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"The specific query params used will depend if its an massive product synchronization, or an individual one."}),"\n",(0,t.jsx)(n.li,{children:"The pipeline parameters used to control that will be described later in this document"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["For each ZCEN obtained, it will try to obtain its contracts using the contract endpoint (/interoperabilidad/servicios/api/v1/materiales/contratos/",(0,t.jsx)(n.code,{children:"<zgen_code>"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"Each ZGEN product with its given contracts is sent to the next step of the pipeline"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"2---transformer",children:"2 - Transformer"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"In charge of filtering and manipulating the entry data"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"For each ZGEN product, it will check if it at least one valid contract"}),"\n",(0,t.jsx)(n.li,{children:"Valid contracts are ones that have a current date. Meaning the start date has already passed (contract already running), and the end date hasnt yet elapsed (contract hasnt expired)"}),"\n",(0,t.jsx)(n.li,{children:"ZGEN products are filtered considering that logic"}),"\n",(0,t.jsx)(n.li,{children:"The remaining valid entries are sent to the next step of the pipeline"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"3---data-exporter",children:"3 - Data exporter"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"In charge of loading data into Spree"})}),"\n",(0,t.jsx)(n.p,{children:"Data is loaded onto Spree using Api v2 platform endpoints."}),"\n",(0,t.jsx)(n.p,{children:"In broader terms, the loading strategy used was to create entities, and update those with new data if any changes are perceived."}),"\n",(0,t.jsxs)(n.p,{children:["Information about the general (non decorated, non customized) Spree Api V2 endpoint collections can be found on the ",(0,t.jsx)(n.a,{href:"https://api.spreecommerce.org/docs/api-v2/0e192836641aa-platform-api",children:"Spree API Documentation"}),"."]}),"\n",(0,t.jsxs)(n.admonition,{type:"info",children:[(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Postman collection with actual endpoints used:"})}),(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:i(1278).Z+"",children:"Postman collection"})})]}),"\n",(0,t.jsxs)(n.p,{children:["To autenticate and use the endpoints of the API, it is necesary to create an oAuth Application inside the Spree Admin backoffice:\n",(0,t.jsx)(n.a,{href:"https://dev-docs.spreecommerce.org/api/platform-api/authenticating-requests",children:"https://dev-docs.spreecommerce.org/api/platform-api/authenticating-requests"})]}),"\n",(0,t.jsxs)(n.p,{children:["The application created must have the scope ",(0,t.jsx)(n.code,{children:"admin"})," associated."]}),"\n",(0,t.jsx)(n.p,{children:"The generated Client ID and client secret must be stored, and exposed through the correspondint env variables to the MageAI process:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"SPREE_CLIENT_ID\nSPREE_CLIENT_SECRET\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"First, it will request a token (/spree_oauth/token) using the forementioned client_id/client_secret credentials."}),"\n",(0,t.jsxs)(n.li,{children:["It will obtain general information about the Spree environment, this information will be used to create/update other records in the process.","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Data from Spree Stores (/api/v2/platform/stores)"}),"\n",(0,t.jsx)(n.li,{children:"Data from parent Taxons (/api/v2/platform/taxons)"}),"\n",(0,t.jsx)(n.li,{children:"Data from Product properties (/api/v2/platform/properties)"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["For each filtered ZGEN product with its corresponding contracts:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"It will try to create/update the ZGEN contract data (/api/v2/platform/generic_products)"}),"\n",(0,t.jsxs)(n.li,{children:["For each product contract:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"It will try to create/update the Vendor data (/api/v2/platform/vendors)"}),"\n",(0,t.jsx)(n.li,{children:"Using the corresponding vendor and other information, it will try to create/update the Product data (/api/v2/platform/products)"}),"\n",(0,t.jsx)(n.li,{children:"Using the corresponding product and other information, it will try to create/update the Contract data (/api/v2/platform/contracts)"}),"\n",(0,t.jsx)(n.li,{children:"Using the corresponding product and other information, It will try to update the Product's master variant data (/api/v2/platform/variants)"}),"\n",(0,t.jsx)(n.li,{children:"Using the corresponding master variant and other information, It will try to update the Variant stock item information (/api/v2/platform/stock_items, /api/v2/platform/stock_locations)"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Synchronization results for each product are stored and sumarized, those stats are returned as the pipeline exit:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Succesful count of ZGEN products syncronized"}),"\n",(0,t.jsx)(n.li,{children:"Error count of ZGEN products syncronized"}),"\n",(0,t.jsx)(n.li,{children:"SKUs of ZGEN products with errors on syncronization"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"pipeline-results",src:i(9217).Z+"",width:"1203",height:"420"})}),"\n",(0,t.jsx)(n.p,{children:"More information about the pipeline excecution can be found in the logs section of the MageAI Dashboard:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"/pipelines/product_data_pipeline/logs"})}),"\n",(0,t.jsx)(n.h3,{id:"pipeline-variables",children:"Pipeline variables"}),"\n",(0,t.jsx)(n.p,{children:"These are the variables that the pipeline uses to parametrize its behaviour."}),"\n",(0,t.jsxs)(n.p,{children:["They can be configured per trigger basis as ",(0,t.jsx)(n.strong,{children:"Runtime variables"}),"."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"codigo_product_initial_range"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"(Integer) Limits the minimum value of the SKU code to use for processing ZGEN products, inclusive"}),"\n",(0,t.jsx)(n.li,{children:"Default: None (not set)"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"codigo_product_final_range"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"(Integer) Limits the maximum value of the SKU code to use for processing ZGEN products, inclusive"}),"\n",(0,t.jsx)(n.li,{children:"Default: None (not set)"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"max_number_of_products_to_process"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"(Integer) Limits the number of products to process to a maximum, skipping the rest of the records."}),"\n",(0,t.jsx)(n.li,{children:"Default: None (not set)"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"product_code"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["(Integer) Defines an specific product SKU code to process, this value will be used to call the ",(0,t.jsx)(n.code,{children:"/materiales/listacatalogo"})," endpoint (parameter ",(0,t.jsx)(n.code,{children:"codigoProducto"}),"). Enabling this will switch to individual record processing."]}),"\n",(0,t.jsx)(n.li,{children:"Default: None (not set)"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"group_article"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["(String) Defines an specific product group to process, this value will be used to call the ",(0,t.jsx)(n.code,{children:"/materiales/listacatalogo"})," endpoint (parameter ",(0,t.jsx)(n.code,{children:"grupoArticulo"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"Default: None (not set)"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"sector_code"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["(String) Defines an specific product sector code to process, this value will be used to call the ",(0,t.jsx)(n.code,{children:"/materiales/listacatalogo"})," endpoint (parameter ",(0,t.jsx)(n.code,{children:"codigoSector"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"Default: None (not set)"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"page_size"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["(Integer) Defines an specific page size to use upon Cenabast product fetch, this value will be used to call the ",(0,t.jsx)(n.code,{children:"/materiales/listacatalogo"})," endpoint (parameter ",(0,t.jsx)(n.code,{children:"PageSize"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"Default: 5_000_000"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"page_size"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["(Integer) Defines an specific page number to use upon Cenabast product fetch, this value will be used to call the ",(0,t.jsx)(n.code,{children:"/materiales/listacatalogo"})," endpoint (parameter ",(0,t.jsx)(n.code,{children:"PageNumber"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"Default: None (not set)"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"product-attributes-that-are-not-managed-by-the-pipeline",children:"Product attributes that are not managed by the Pipeline"}),"\n",(0,t.jsx)(n.p,{children:"(as of 2024-03-18)"}),"\n",(0,t.jsx)(n.p,{children:"The pipeline tries to store the most possible of the generic product and contract information, and create associated Spree records to work around them and enable to buy them."}),"\n",(0,t.jsx)(n.p,{children:"However, there are some attributes required for Spree that are not given by the Cenabast endpoints, or we lack of a formal definition in order on how to load those automatically:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Product images"}),"\n",(0,t.jsx)(n.li,{children:"Product taxonomies (Categorization of products)"}),"\n",(0,t.jsx)(n.li,{children:"Product description"}),"\n",(0,t.jsx)(n.li,{children:"Product meta-tags"}),"\n",(0,t.jsx)(n.li,{children:"Product stock"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Those attributes can be managed by the Spree admin panel, in the Products section (/admin/products)."}),"\n",(0,t.jsxs)(n.p,{children:["\u26a0\ufe0f"," Requires to be accesed by an admin enabled user."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"product-edition",src:i(2525).Z+"",width:"1920",height:"953"})}),"\n",(0,t.jsx)(n.h3,{id:"triggers",children:"Triggers"}),"\n",(0,t.jsx)(n.p,{children:"A trigger of type scheduled was created to handle the daily scheduled syncronization of records.\nWhen configuring a trigger, a set of pipeline configuration parameters can be given:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"trigger-variables",src:i(8787).Z+"",width:"470",height:"524"})}),"\n",(0,t.jsx)(n.p,{children:"More triggers can be created with different options."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"An API trigger can be created to expose a webhook that will trigger the pipeline execution"}),"\n",(0,t.jsxs)(n.li,{children:["When calling the API endpoint, pipeline parameters can be sent in the payload, allowing us to handle individual syncronization, or another scoped sincronization process:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.mage.ai/orchestration/triggers/trigger-pipeline-api",children:"https://docs.mage.ai/orchestration/triggers/trigger-pipeline-api"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"important-environment-variables",children:"Important environment variables"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"CENABAST_API_BASE_URL"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Root URL to use for Cenabast API"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"CENABAST_API_BASE_PATH"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Base path that points to the root of the API to use"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"CENABAST_API_USER"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"API User to obtain a token from"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"CENABAST_API_PASSWORD"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Password of the API user"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"SPREE_API_BASE_URL"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Root URL to use Spree API"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"SPREE_CLIENT_ID"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Spree Client ID to use for API authentication"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"SPREE_CLIENT_SECRET"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Spree Client ID to use for API authentication"}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},1278:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/files/spree-api-v2-plaftorm-examples.postman_collection-6168dd76a0353f2dd4fe72acec378129.json"},9217:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/pipeline-results-6e8abf9028941b989e39e0d94e31c95d.png"},5783:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/pipeline-8fcd10ca4e13faefb7348abd9108e034.png"},2525:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/product-edition-9fec5eea8c9f933f5a83f4ffd18c0aed.gif"},8787:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/trigger-variables-cccc32f00d50000cc126653555da0ab1.png"},1151:(e,n,i)=>{i.d(n,{Z:()=>a,a:()=>o});var t=i(7294);const r={},s=t.createContext(r);function o(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);